<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title> - 爱像水墨青花</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="lflxp" /><meta name="description" content="Kubernetes Controller 介绍 0. 概述 Kubernetes提供了很多Controller资源来管理、调度Pod，包括Replication Controller、ReplicaSet、Deployments、StatefulSet、DaemonSet等等。本文介绍这些控制器的功能和用法。控制器是Kubernetes中的一种资源，用来方便管理Pod。可以把控制器想象成进程管理器，负责维护进程的状态。进程掉了负责拉起，需要更多进程了负责增加进程，可以监控进程根据进程消耗资源的情况动态扩缩容。只是在Kubernetes中，控制器管理的是Pods。Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。
Spec 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  apiVersion:apps/v1kind:ReplicaSetmetadata:spec:replicas:#默认为1selector:template:metadata:labels:spec:containers:-name:image-nameimage:  必须字段 1.9版本之后，应当使用 apps/v1。
Pod Template Pod Selector 并不区分Pod的创建人或进程，好处是容易被其他的管理工具替换。
 Also you should not normally create any pods whose labels match this selector, either directly, with another ReplicaSet, or with another controller such as a Deployment. If you do so, the ReplicaSet thinks that it created the other pods." /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.62.2 with theme even" />


<link rel="canonical" href="https://www.lflxp.cn/post/k8s-go/controller/readme/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="" />
<meta property="og:description" content="Kubernetes Controller 介绍 0. 概述 Kubernetes提供了很多Controller资源来管理、调度Pod，包括Replication Controller、ReplicaSet、Deployments、StatefulSet、DaemonSet等等。本文介绍这些控制器的功能和用法。控制器是Kubernetes中的一种资源，用来方便管理Pod。可以把控制器想象成进程管理器，负责维护进程的状态。进程掉了负责拉起，需要更多进程了负责增加进程，可以监控进程根据进程消耗资源的情况动态扩缩容。只是在Kubernetes中，控制器管理的是Pods。Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。
Spec 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  apiVersion:apps/v1kind:ReplicaSetmetadata:spec:replicas:#默认为1selector:template:metadata:labels:spec:containers:-name:image-nameimage:  必须字段 1.9版本之后，应当使用 apps/v1。
Pod Template Pod Selector 并不区分Pod的创建人或进程，好处是容易被其他的管理工具替换。
 Also you should not normally create any pods whose labels match this selector, either directly, with another ReplicaSet, or with another controller such as a Deployment. If you do so, the ReplicaSet thinks that it created the other pods." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.lflxp.cn/post/k8s-go/controller/readme/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="Kubernetes Controller 介绍 0. 概述 Kubernetes提供了很多Controller资源来管理、调度Pod，包括Replication Controller、ReplicaSet、Deployments、StatefulSet、DaemonSet等等。本文介绍这些控制器的功能和用法。控制器是Kubernetes中的一种资源，用来方便管理Pod。可以把控制器想象成进程管理器，负责维护进程的状态。进程掉了负责拉起，需要更多进程了负责增加进程，可以监控进程根据进程消耗资源的情况动态扩缩容。只是在Kubernetes中，控制器管理的是Pods。Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。
Spec 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  apiVersion:apps/v1kind:ReplicaSetmetadata:spec:replicas:#默认为1selector:template:metadata:labels:spec:containers:-name:image-nameimage:  必须字段 1.9版本之后，应当使用 apps/v1。
Pod Template Pod Selector 并不区分Pod的创建人或进程，好处是容易被其他的管理工具替换。
 Also you should not normally create any pods whose labels match this selector, either directly, with another ReplicaSet, or with another controller such as a Deployment. If you do so, the ReplicaSet thinks that it created the other pods.">

<meta itemprop="wordCount" content="588">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Kubernetes Controller 介绍 0. 概述 Kubernetes提供了很多Controller资源来管理、调度Pod，包括Replication Controller、ReplicaSet、Deployments、StatefulSet、DaemonSet等等。本文介绍这些控制器的功能和用法。控制器是Kubernetes中的一种资源，用来方便管理Pod。可以把控制器想象成进程管理器，负责维护进程的状态。进程掉了负责拉起，需要更多进程了负责增加进程，可以监控进程根据进程消耗资源的情况动态扩缩容。只是在Kubernetes中，控制器管理的是Pods。Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。
Spec 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  apiVersion:apps/v1kind:ReplicaSetmetadata:spec:replicas:#默认为1selector:template:metadata:labels:spec:containers:-name:image-nameimage:  必须字段 1.9版本之后，应当使用 apps/v1。
Pod Template Pod Selector 并不区分Pod的创建人或进程，好处是容易被其他的管理工具替换。
 Also you should not normally create any pods whose labels match this selector, either directly, with another ReplicaSet, or with another controller such as a Deployment. If you do so, the ReplicaSet thinks that it created the other pods."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">琵琶</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">目录</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">琵琶</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">目录</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title"></h1>

      <div class="post-meta">
        <span class="post-time"> 0001-01-01 </span>
        
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#kubernetes-controller-介绍">Kubernetes Controller 介绍</a></li>
    <li><a href="#0-概述">0. 概述</a>
      <ul>
        <li><a href="#spec">Spec</a></li>
        <li><a href="#必须字段">必须字段</a></li>
        <li><a href="#pod-template">Pod Template</a></li>
        <li><a href="#pod-selector">Pod Selector</a></li>
      </ul>
    </li>
    <li><a href="#1-replicationcontroller">1. ReplicationController</a>
      <ul>
        <li><a href="#11-常用管理操作">1.1 常用管理操作</a></li>
        <li><a href="#12-常用场景">1.2 常用场景</a></li>
      </ul>
    </li>
    <li><a href="#2-replicaset">2. ReplicaSet</a>
      <ul>
        <li><a href="#21-常用管理操作">2.1 常用管理操作</a></li>
      </ul>
    </li>
    <li><a href="#3-deployments">3. Deployments</a>
      <ul>
        <li><a href="#31-创建部署-deployment">3.1 创建部署 Deployment</a></li>
        <li><a href="#32-更新部署-deployment">3.2 更新部署 Deployment</a></li>
        <li><a href="#33-回滚更新">3.3 回滚更新</a></li>
        <li><a href="#34-扩容">3.4 扩容</a></li>
        <li><a href="#35-暂停deployment">3.5 暂停Deployment</a></li>
        <li><a href="#36-deployment的状态">3.6 Deployment的状态</a></li>
        <li><a href="#37-一些参数">3.7 一些参数</a></li>
      </ul>
    </li>
    <li><a href="#4-statefulsets">4. StatefulSets</a></li>
    <li><a href="#5-daemonset">5. DaemonSet</a></li>
    <li><a href="#6-grabage-collection">6. Grabage Collection</a></li>
    <li><a href="#7-jobs">7. Jobs</a></li>
    <li><a href="#8-cronjob">8. CronJob</a></li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="0001-01-01T00:00:00" title="January 1, 0001">January 1, 0001</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <h2 id="kubernetes-controller-介绍">Kubernetes Controller 介绍</h2>
<h2 id="0-概述">0. 概述</h2>
<p>Kubernetes提供了很多Controller资源来管理、调度Pod，包括Replication Controller、ReplicaSet、Deployments、StatefulSet、DaemonSet等等。本文介绍这些控制器的功能和用法。控制器是Kubernetes中的一种资源，用来方便管理Pod。可以把控制器想象成进程管理器，负责维护进程的状态。进程掉了负责拉起，需要更多进程了负责增加进程，可以监控进程根据进程消耗资源的情况动态扩缩容。只是在Kubernetes中，控制器管理的是Pods。Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。</p>
<h3 id="spec">Spec</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ReplicaSet<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="c">#默认为1</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>image-name<span class="w">
</span><span class="w">        </span>image<span class="p">:</span><span class="w">
</span><span class="w">        
</span></code></pre></td></tr></table>
</div>
</div><h3 id="必须字段">必须字段</h3>
<p>1.9版本之后，应当使用 <code>apps/v1</code>。</p>
<h3 id="pod-template">Pod Template</h3>
<h3 id="pod-selector">Pod Selector</h3>
<p>并不区分Pod的创建人或进程，好处是容易被其他的管理工具替换。</p>
<blockquote>
<p>Also you should not normally create any pods whose labels match this selector, either directly, with another ReplicaSet, or with another controller such as a Deployment. If you do so, the ReplicaSet thinks that it created the other pods. Kubernetes does not stop you from doing this.</p>
</blockquote>
<h2 id="1-replicationcontroller">1. ReplicationController</h2>
<p>Replication Controller 通常缩写为 rc、rcs。RC同RS一样，保持Pod数量始终维持在期望值。RC创建的Pod，遇到失败后会自动重启。RC的编排文件必须的字段包括apiVersion、kind、metadata、.spec.repicas、.spec.template。其中<code>.spec.template.spec.restartPolicy</code> 只能是 <code>Always</code>，默认为空。看一下RC的编排文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ReplicationController<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">        </span>image<span class="p">:</span><span class="w"> </span>docker.io/nginx<span class="w">
</span><span class="w">        </span>ports<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="11-常用管理操作">1.1 常用管理操作</h3>
<ul>
<li>删除RC和相关的Pod，使用<code>kubectl delete</code>命令删除RC，会同步删除RC创建的Pods</li>
<li>仅删除RC，使用<code>kubectl delete --cascade=false</code>仅删除RC而不删除相关的Pods</li>
<li>隔离Pod，通过修改标签的方式隔离Pod</li>
</ul>
<h3 id="12-常用场景">1.2 常用场景</h3>
<ul>
<li>Rescheduling，RC控制器会确保集群中始终存在你设定数量的Pod在运行</li>
<li>Scaling，通过修改replicas字段，可以方便的扩容</li>
<li>Rolling updates，可以使用命令行工具<code>kubectl rolling-update</code>实现滚动升级</li>
<li>Multriple release tracks，配合label和service，可以实现金丝雀发布</li>
<li>与Services配合</li>
</ul>
<blockquote>
<p>RC没有探测功能，也没有自动扩缩容功能。也不会检查</p>
</blockquote>
<h2 id="2-replicaset">2. ReplicaSet</h2>
<p>RS是RC的下一代，只有对于标签选择的支持上有所不同，RS支持集合方式的选择，RC仅支持相等方式的选择。ReplicasSet确保集群在任何时间都运行指定数量的Pod副本，看一下RS的编排文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ReplicaSet<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">    </span>tier<span class="p">:</span><span class="w"> </span>frontend<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">      </span>tier<span class="p">:</span><span class="w"> </span>frontend<span class="w">
</span><span class="w">    </span>matchExpressions<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>{key<span class="p">:</span>tier<span class="p">,</span><span class="w"> </span>operator<span class="p">:</span><span class="w"> </span>In<span class="p">,</span><span class="w"> </span>values<span class="p">:</span><span class="w"> </span><span class="p">[</span>frontend<span class="p">]</span>}<span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">        </span>tier<span class="p">:</span><span class="w"> </span>frontend<span class="w">
</span><span class="w">      </span>spec<span class="p">:</span><span class="w">
</span><span class="w">        </span>containers<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">          </span>image<span class="p">:</span><span class="w"> </span>docker.io/nginx<span class="w">
</span><span class="w">          </span>resources<span class="p">:</span><span class="w">
</span><span class="w">            </span>requests<span class="p">:</span><span class="w">
</span><span class="w">              </span>cpu<span class="p">:</span><span class="w"> </span>100m<span class="w">
</span><span class="w">              </span>memory<span class="p">:</span><span class="w"> </span>100Mi<span class="w">
</span><span class="w">            </span>ports<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>编排文件必须的几个字段包括：apiVersion、kind、metadata、spec以及spec.replicas、spec.template、spec.selector。</p>
<blockquote>
<p>尽管ReplicaSet可以单独使用，但是如今推荐使用Deployments做为Pod编排的（新建、删除、更新）的主要方式。Deploymnets是更高一级的抽象，提供了RS的管理功能，除非你要使用自定义的更新编排或者不希望所有Pod进行更新，否则基本上没有用到RS的机会。</p>
</blockquote>
<h3 id="21-常用管理操作">2.1 常用管理操作</h3>
<ul>
<li>删除RS和相关Pods，<code>kubectl delete &lt;rs-name&gt;</code></li>
<li>仅删除RS，<code>kubectl delete &lt;rs-name&gt; --cascade=false</code></li>
<li>Pod 隔离，通过修改Pod的label，可以将Pod隔离从而进行测试、数据恢复等操作。
－ HPA 自动扩容，ReplicaSet可以作为HPA的目标</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>autoscaling/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>HorizontalPodAutoscaler<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>nginx-scaler<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>scaleTargetRef<span class="p">:</span><span class="w">
</span><span class="w">    </span>kind<span class="p">:</span><span class="w"> </span>ReplicaSet<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">  </span>minReplicas<span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span>maxReplicas<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span>targetCPUUtilizationPercentage<span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="3-deployments">3. Deployments</h2>
<p>Deployment实际上是对RS和Pod的管理，它总先是创建RS，由RS创建Pods。由Deployment创建的RS的命名规则为<code>[DEPLOYMENT-NAME]-[POD-TEMPLATE-HASH-VALUE]</code>，建议不要手工维护Deployment创建的RS。Deployment的更新仅在Pod的template发生更新的情况下。</p>
<p>下面介绍几个Deployment使用的典型场景。</p>
<h3 id="31-创建部署-deployment">3.1 创建部署 Deployment</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>nginx-deployment<span class="w">        </span>//部署名称<span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">                   </span>//副本数量<span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">                     </span>//Pod选择规则<span class="w">
</span><span class="w">    </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">      </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">                   </span>//Pods标签<span class="w">
</span><span class="w">        </span>app<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>nginx<span class="w">
</span><span class="w">        </span>image<span class="p">:</span><span class="w"> </span>docker.io/nginx<span class="p">:</span><span class="m">1.7</span><span class="m">.9</span><span class="w">
</span><span class="w">        </span>ports<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>contaienrPort<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">kubectl apply -f dp.yaml
kubectl get deployment nginx-deployment
kubectl rollout status deployment nginx-deployment
kubectl get pods --show-labels
</code></pre></td></tr></table>
</div>
</div><h3 id="32-更新部署-deployment">3.2 更新部署 Deployment</h3>
<p>如果需要对已经创建的Deployment进行更新有两种方法，一种是修改编排文件并应用更新，一种是直接通过命令的方式更新部署的参数，分别介绍如下。</p>
<p><strong>命令方式更新</strong>
更新镜像文件的版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">kubectl <span class="nb">set</span> image depolyment/nginx-deployment <span class="nv">nginx</span><span class="o">=</span>docker.io/nginx:1.9.1
</code></pre></td></tr></table>
</div>
</div><p><strong>更新编排文件的方式</strong>
首先修改编排文件，然后执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">kubectl apply -f dp.yaml
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>如果一个Deployment已经创建完成，更新Deployment会创建新的RS并逐渐的替换旧的RS（按一定的速率创建新的Pod，确保新的Pod运行正常后，删掉旧的Pod）。因此如果查看Pods，可能会发现一段时间Pods的总量会超过replicas设定的数量。如果一个Deployment正在创建还没有完成，此时更新Deployment会导致刚创建的Pods马上被杀掉，并开始创建新的Pods。</p>
</blockquote>
<h3 id="33-回滚更新">3.3 回滚更新</h3>
<p>有时部署的版本存在问题，我们需要回滚到之前的版本，Deployment也提供了这种功能。默认情况下，Deployment的更新保存在系统中，我们能够据此实现版本的回滚。</p>
<blockquote>
<p>只有更新.spec.template的内容才会触发版本记录，单纯的扩容不会记录历史。因此回滚也不会造成Pods数量的变化。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">kubectl apply -f dp.yaml
kubectl <span class="nb">set</span> image deployment/nginx-deployment <span class="nv">nginx</span><span class="o">=</span>docker.io/nginx:1.91
kubectl rollout status deployments nginx-deployment
kubectl get rs
kubectl get pods
<span class="c1"># kubectl rollout history deployment/nginx-deployment</span>
kubectl rollout <span class="nb">history</span> deployment/nginx-deployment --revision<span class="o">=</span><span class="m">2</span>
kubectl rollout undo deployment/nginx-deployment
kubectl rollout undown deployment/nginx-deployment --to-revision<span class="o">=</span><span class="m">2</span>
kubectl get deployment
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>默认记录10个版本，可以通过<code>.spec.revisionHistoryLimit</code>修改。</p>
</blockquote>
<h3 id="34-扩容">3.4 扩容</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># kubectl scale deployment nginx-deployment --replicas=5</span>
</code></pre></td></tr></table>
</div>
</div><p>如果集群打开了自动扩容功能，还可以设置自动扩容的条件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># kubectl autoscale deployment nginx-deployment --min=10 --max=15 --cpu-percent=80</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="35-暂停deployment">3.5 暂停Deployment</h3>
<p>创建部署之后，我们可以暂停和重启部署过程，并在此期间执行一些操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl rollout pause deployment/nginx-deployment
$
$ kubectl rollout resume deployment/nginx-deployment
</code></pre></td></tr></table>
</div>
</div><h3 id="36-deployment的状态">3.6 Deployment的状态</h3>
<p>Deployment包含几种可能的状态。</p>
<ul>
<li>Progressing
<ul>
<li>创建了新的ReplicaSet</li>
<li>正在对新的ReplicaSet进行Scaling up</li>
<li>正在对旧的ReplicaSet进行Scaling down</li>
<li>新的Pods准备就绪</li>
</ul>
</li>
<li>Complete
<ul>
<li>所有的副本都已更新为最新状态</li>
<li>所有的副本都已可用</li>
<li>没有旧的副本正在运行</li>
</ul>
</li>
<li>Failed
<ul>
<li>Quota不足</li>
<li>Readiness探测失败</li>
<li>镜像拉取失败</li>
<li>权限不足</li>
<li>应用运行错误</li>
</ul>
</li>
</ul>
<h3 id="37-一些参数">3.7 一些参数</h3>
<ul>
<li>Strategy <code>.spec.strategy</code>，这个有两个选项，分别是Recreate和RollingUpdate，默认为第二种。第一种的策略为先杀死旧Pods再创建新Pods，第二种为一边创建新Pods，一边杀掉旧Pods</li>
<li>Max Unavailable <code>.spec.strategy.rollingUpdate.maxUnavailable</code>，更新过程中允许不可用Pods的最大比率，默认为25%</li>
<li>Max Surge <code>.spec.strategy.rollingUpdate.maxSurge</code>，更新过程中允许超过replicas的最大Pods数量，默认为25%</li>
<li>Progress Deadline Seconds <code>.spec.progressDeadlineSeconds</code> ，可选参数，设置系统报告进展的时间</li>
<li>Min Ready Seconds <code>.spec.minReadySeconds</code>，可选参数，设置新建Pod能正常运行的最小时间间隔</li>
<li>Revision History Limit <code>.spec.revisionHistoryLimit</code> 可选参数，设置历史记录数量</li>
</ul>
<h2 id="4-statefulsets">4. StatefulSets</h2>
<p>SteatefulSets我专门有一篇文件介绍，大家可以参考<a href="https://www.cnblogs.com/cocowool/p/kubernetes_statefulset.html">这里</a>。</p>
<h2 id="5-daemonset">5. DaemonSet</h2>
<p>DaemonSet确保所有的Node上都运行了一份Pod的副本，只要Node加入到集群中，Pod就会在Node上创建。典型的应用场景包括：运行一个存储集群（glusterd,ceph）、运行一个日志收集集群（fluentd,logstash）、运行监控程序（Prometheus Node Exporter,collectd,Datadog等）。默认情况下DaemonSet由DaemonSet控制器调度，如果设置了<code>nodeAffinity</code>参数，则会有默认的scheduler调度。</p>
<p>典型的编排文件如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>DaemonSet<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>fluentd-es<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>kube-system<span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>k8s-app<span class="p">:</span><span class="w"> </span>fluentd-logging<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>fluentd-es<span class="w">
</span><span class="w">    </span>template<span class="p">:</span><span class="w">
</span><span class="w">      </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">        </span>labels<span class="p">:</span><span class="w">
</span><span class="w">          </span>name<span class="p">:</span><span class="w"> </span>fluentd-es<span class="w">
</span><span class="w">      </span>spec<span class="p">:</span><span class="w">
</span><span class="w">        </span>tolerations<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>key<span class="p">:</span><span class="w"> </span>node-role.kubernetes.io/master<span class="w">
</span><span class="w">          </span>effect<span class="p">:</span><span class="w"> </span>NoSchedule<span class="w">
</span><span class="w">        </span>containers<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>fluentd-es<span class="w">
</span><span class="w">          </span>image<span class="p">:</span><span class="w"> </span>docker.io/fluentd<span class="p">:</span><span class="m">1.20</span><span class="w">
</span><span class="w">          </span>resources<span class="p">:</span><span class="w">
</span><span class="w">            </span>limits<span class="p">:</span><span class="w">
</span><span class="w">              </span>memory<span class="p">:</span><span class="w"> </span>200Mi<span class="w">
</span><span class="w">            </span>requests<span class="p">:</span><span class="w">
</span><span class="w">              </span>cpu<span class="p">:</span><span class="w"> </span>100m<span class="w">
</span><span class="w">              </span>memory<span class="p">:</span><span class="w"> </span>200Mi<span class="w">
</span><span class="w">          </span>volumeMounts<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>varlog<span class="w">
</span><span class="w">            </span>mountPath<span class="p">:</span><span class="w"> </span>/var/log<span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>varlibdockercontainers<span class="w">
</span><span class="w">            </span>mountPath<span class="p">:</span><span class="w"> </span>/var/lib/docker/containers<span class="w">
</span><span class="w">            </span>readOnly<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">          </span>terminationGracePeriodSeconds<span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">          </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>varlog<span class="w">
</span><span class="w">            </span>hostPath<span class="p">:</span><span class="w">
</span><span class="w">              </span>path<span class="p">:</span><span class="w"> </span>/var/log<span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>varlibdockercontainers<span class="w">
</span><span class="w">            </span>hostPath<span class="p">:</span><span class="w">
</span><span class="w">              </span>path<span class="p">:</span><span class="w"> </span>/var/lib/docker/contaienrs<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="6-grabage-collection">6. Grabage Collection</h2>
<p>Kubernetes中一些对象间有从属关系，例如一个RS会拥有一组Pod。Kubernetes中的GC用来删除那些曾经有过属主，但是后来没有属主的对象。Kubernetes中拥有属主的对象有一个<code>metadata.ownerReferences</code>属性指向属主。在Kubernetes的1.8版本之后，系统会自动为ReplicationController、ReplicaSet、StatefulSet、DaemonSet、Deployment、Job和CronJob创建的对象设置ownerReference。</p>
<p>之前各种控制器中我们提到过级联删除，就是通过这个属性来实现的。级联删除有两种形式 Foreground 以及 Background ，Foreground模式中，选择级联删除后GC会自动将所有<code>ownerReference.blockOwnerDeletion=true</code>的对象删除，最后再删除owner对象。Background模式中，owner对象会被立即删除，然后GC在后台删除其他依赖对象。如果我们在删除RS的时候，选择不进行级联删除，那么这个RS创建的Pods就变成了没有属主的孤儿。</p>
<h2 id="7-jobs">7. Jobs</h2>
<p>Job通过创建一个或多个Pod来运行特定的任务，当正常完成任务的Pod数量达到设定标准时，Job就会结束。删除Job会将Job创建的所有Pods删除。</p>
<p>典型的编排文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>batch/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Job<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>pi<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>backoffLimit<span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">  </span>activeDeadlineSeconds<span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>pi<span class="w">
</span><span class="w">        </span>image<span class="p">:</span><span class="w"> </span>docker.io/perl<span class="w">
</span><span class="w">        </span>command<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;perl&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-Mbignum=bpi&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-wle&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;print bpid(2000)&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">      </span>restartPolicy<span class="p">:</span><span class="w"> </span>Never<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>主要有三种类型的Job</p>
<ul>
<li>非并行的Job，通常只启动一个Pod执行任务</li>
<li>带有固定完成数量的并行Job，需要将<code>.spec.completions</code>设置为非零值</li>
<li>与队列结合的并行Job，不需要设置<code>.spec.completions</code>，设置<code>.spec.parallelism</code></li>
</ul>
<blockquote>
<p>Note that even if you specify .spec.parallelism = 1 and .spec.completions = 1 and .spec.template.spec.restartPolicy = &ldquo;Never&rdquo;, the same program may sometimes be started twice.
感觉有坑啊。</p>
</blockquote>
<p>Kubernetes提供的并行Job并不适合科学计算或者执行相关的任务，更适合执行邮件发送、渲染、文件转义等等单独的任务。</p>
<h2 id="8-cronjob">8. CronJob</h2>
<p>Cron Job是根据时间来自动创建Job对象。类似于Crontab，周期性的执行一个任务。每次执行期间，会创建一个Job对象。也可能会创建两个或者不创建Job，这个情况可能会发生，因此应该保证Job是幂等的。</p>
<blockquote>
<p>For every CronJob, the CronJob controller checks how many schedules it missed in the duration from its last scheduled time until now. If there are more than 100 missed schedules, then it does not start the job and logs the error 如果错过太多，就不要追了</p>
</blockquote>
<p>典型的编排文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>batch/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>CronJob<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>hello<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>schedule<span class="p">:</span><span class="w"> </span><span class="s2">&#34;*/1 * * * *&#34;</span><span class="w">
</span><span class="w">  </span>jobTemplate<span class="p">:</span><span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>template<span class="p">:</span><span class="w">
</span><span class="w">        </span>spec<span class="p">:</span><span class="w">
</span><span class="w">          </span>containers<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>hello<span class="w">
</span><span class="w">            </span>image<span class="p">:</span><span class="w"> </span>docker.io/busybox<span class="w">
</span><span class="w">            </span>args<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>/bin/sh<span class="w">
</span><span class="w">            </span>-<span class="w"> </span>-c<span class="w">
</span><span class="w">            </span>-<span class="w"> </span>date;<span class="w"> </span>echo<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>Kubernetes<span class="w"> </span>cluster<span class="w">
</span><span class="w">          </span>restartPolicy<span class="p">:</span><span class="w"> </span>OnFailure<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>所有的编排文件都上传到了我的<a href="https://github.com/cocowool/k8s-go/tree/master/controller">Github</a>上，大家可以自行<a href="https://github.com/cocowool/k8s-go/tree/master/controller">下载</a>。</p>
<p><img src="https://images2018.cnblogs.com/blog/39469/201807/39469-20180710163655709-89635310.png" alt=""></p>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">Kubernetes ReplicaSet</a></li>
<li><a href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/">Running Automated Tasks with a CronJob</a></li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">lflxp</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        0001-01-01
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/hyperdl-tutorial/readme/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default"></span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/k8s-go/elk/readme/">
            <span class="next-text nav-default"></span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="comments-gitment"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitment = new Gitment({
        id: '0001-01-01 00:00:00 \x2b0000 UTC',
        title: '',
        link: decodeURI(location.href),
        desc: 'Kubernetes Controller 介绍 0. 概述 Kubernetes提供了很多Controller资源来管理、调度Pod，包括Replication Controller、ReplicaSet、Deployments、StatefulSet、DaemonSet等等。本文介绍这些控制器的功能和用法。控制器是Kubernetes中的一种资源，用来方便管理Pod。可以把控制器想象成进程管理器，负责维护进程的状态。进程掉了负责拉起，需要更多进程了负责增加进程，可以监控进程根据进程消耗资源的情况动态扩缩容。只是在Kubernetes中，控制器管理的是Pods。Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。\nSpec 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  apiVersion:apps\/v1kind:ReplicaSetmetadata:spec:replicas:#默认为1selector:template:metadata:labels:spec:containers:-name:image-nameimage:  必须字段 1.9版本之后，应当使用 apps\/v1。\nPod Template Pod Selector 并不区分Pod的创建人或进程，好处是容易被其他的管理工具替换。\n Also you should not normally create any pods whose labels match this selector, either directly, with another ReplicaSet, or with another controller such as a Deployment. If you do so, the ReplicaSet thinks that it created the other pods.',
        owner: 'lflxp',
        repo: 'https:\/\/github.com\/lflxp\/lflxp.github.com',
        oauth: {
          client_id: '',
          client_secret: ''
        }
      });
      gitment.render('comments-gitment');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:382023823@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/lflxp" class="iconfont icon-github" title="github"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-douban" title="douban"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-pocket" title="pocket"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-instagram" title="instagram"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="https://www.lflxp.cn" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.lflxp.cn/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2016 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">lflxp.cn 版权所有 ICP证：<a href='http://www.beian.miit.gov.cn' target='_blank'>渝ICP备17011066号-1</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', '渝ICP备17011066号-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
